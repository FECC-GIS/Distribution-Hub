System.register(["jimu-core/emotion","jimu-core","jimu-arcgis","esri/layers/FeatureLayer","esri/rest/support/ProjectParameters","esri/rest/geometryService","esri/geometry/projection","esri/geometry/SpatialReference","esri/geometry/geometryEngine","esri/geometry/Point","esri/Graphic","esri/layers/GraphicsLayer"],function(e,t){var i={},o={},n={},l={},r={},d={},u={},s={},a={},c={},v={},f={};return Object.defineProperty(l,"__esModule",{value:!0}),Object.defineProperty(r,"__esModule",{value:!0}),Object.defineProperty(d,"__esModule",{value:!0}),Object.defineProperty(u,"__esModule",{value:!0}),Object.defineProperty(s,"__esModule",{value:!0}),Object.defineProperty(a,"__esModule",{value:!0}),Object.defineProperty(c,"__esModule",{value:!0}),Object.defineProperty(v,"__esModule",{value:!0}),Object.defineProperty(f,"__esModule",{value:!0}),{setters:[function(e){i.jsx=e.jsx,i.jsxs=e.jsxs},function(e){o.DataSourceComponent=e.DataSourceComponent,o.DataSourceManager=e.DataSourceManager,o.React=e.React},function(e){n.JimuMapViewComponent=e.JimuMapViewComponent},function(e){Object.keys(e).forEach(function(t){l[t]=e[t]})},function(e){Object.keys(e).forEach(function(t){r[t]=e[t]})},function(e){Object.keys(e).forEach(function(t){d[t]=e[t]})},function(e){Object.keys(e).forEach(function(t){u[t]=e[t]})},function(e){Object.keys(e).forEach(function(t){s[t]=e[t]})},function(e){Object.keys(e).forEach(function(t){a[t]=e[t]})},function(e){Object.keys(e).forEach(function(t){c[t]=e[t]})},function(e){Object.keys(e).forEach(function(t){v[t]=e[t]})},function(e){Object.keys(e).forEach(function(t){f[t]=e[t]})}],execute:function(){e((()=>{var e={205:e=>{"use strict";e.exports=s},244:e=>{"use strict";e.exports=o},333:e=>{"use strict";e.exports=u},386:e=>{"use strict";e.exports=i},422:e=>{"use strict";e.exports=c},470:e=>{"use strict";e.exports=v},507:e=>{"use strict";e.exports=r},569:e=>{"use strict";e.exports=d},620:e=>{"use strict";e.exports=f},633:e=>{"use strict";if(void 0===l){var t=new Error("Cannot find module 'esri/layers/FeatureLayer'");throw t.code="MODULE_NOT_FOUND",t}e.exports=l},686:e=>{"use strict";e.exports=n},958:e=>{"use strict";e.exports=a}},t={};function g(i){var o=t[i];if(void 0!==o)return o.exports;var n=t[i]={exports:{}};return e[i](n,n.exports,g),n.exports}g.d=(e,t)=>{for(var i in t)g.o(t,i)&&!g.o(e,i)&&Object.defineProperty(e,i,{enumerable:!0,get:t[i]})},g.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),g.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},g.p="";var y={};return g.p=window.jimuConfig.baseUrl,(()=>{"use strict";g.r(y),g.d(y,{__set_webpack_public_path__:()=>s,default:()=>u});var e=g(386),t=g(244),i=g(686),o=function(e,t,i,o){return new(i||(i=Promise))(function(n,l){function r(e){try{u(o.next(e))}catch(e){l(e)}}function d(e){try{u(o.throw(e))}catch(e){l(e)}}function u(e){var t;e.done?n(e.value):(t=e.value,t instanceof i?t:new i(function(e){e(t)})).then(r,d)}u((o=o.apply(e,t||[])).next())})};const n="https://utility.arcgisonline.com/ArcGIS/rest/services/Geometry/GeometryServer";function l(e){var t,i,o,n,l,r,d,u,s,a,c,v,f,g,y,p,m;return(null!==(m=null!==(p=null!==(y=null!==(g=null!==(f=null!==(v=null!==(c=null!==(a=null!==(s=null!==(u=null!==(d=null!==(r=null!==(l=null!==(n=null!==(o=null!==(i=null!==(t=null==e?void 0:e.Name)&&void 0!==t?t:null==e?void 0:e.NAME)&&void 0!==i?i:null==e?void 0:e.Title)&&void 0!==o?o:null==e?void 0:e.TITLE)&&void 0!==n?n:null==e?void 0:e.AliasName)&&void 0!==l?l:null==e?void 0:e.ALIASNAME)&&void 0!==r?r:null==e?void 0:e.AssetID)&&void 0!==d?d:null==e?void 0:e.ASSETID)&&void 0!==u?u:null==e?void 0:e.StructureID)&&void 0!==s?s:null==e?void 0:e.STRUCTUREID)&&void 0!==a?a:null==e?void 0:e.ConsumerID)&&void 0!==c?c:null==e?void 0:e.CONSUMERID)&&void 0!==v?v:null==e?void 0:e.ID)&&void 0!==f?f:null==e?void 0:e.Id)&&void 0!==g?g:null==e?void 0:e.OBJECTID)&&void 0!==y?y:null==e?void 0:e.ObjectId)&&void 0!==p?p:null==e?void 0:e.ESRI_OID)&&void 0!==m?m:"Feature").toString()}function r(e,t){return t&&null!=(null==e?void 0:e[t])?String(e[t]):l(e)}function d(e){return e?String(e).replace(/\/+$/,""):""}function u(u){var s,a,c,v,f,y,p,m,h,b,j;const[x,S]=t.React.useState([]),[w,k]=t.React.useState(""),[P,R]=t.React.useState(!1),[O,D]=t.React.useState(!1),[I,_]=t.React.useState(null),[C,M]=t.React.useState(!1),[E,T]=t.React.useState(null),[L,B]=t.React.useState(null),W=t.React.useRef(null),[z,U]=t.React.useState([]),[A,N]=t.React.useState({}),[F,G]=t.React.useState(!1),J=null!==(a=null===(s=u.config)||void 0===s?void 0:s.bufferDistance)&&void 0!==a?a:500,V=null!==(v=null===(c=u.config)||void 0===c?void 0:c.bufferUnit)&&void 0!==v?v:"feet",q=null===(f=u.useDataSources)||void 0===f?void 0:f[0],H=null===(y=u.useMapWidgetIds)||void 0===y?void 0:y[0],Q=null===(p=u.config)||void 0===p?void 0:p.vehicleDisplayField,Y=function(e){var t;const i=null===(t=e.config)||void 0===t?void 0:t.widgetTitle,o=null==e?void 0:e.label;return i&&String(i).trim()||o&&String(o).trim()||"Vehicle Buffer List"}(u),$=null!==(h=null===(m=u.config)||void 0===m?void 0:m.targetLayerTitles)&&void 0!==h?h:[],K=null!==(j=null===(b=u.config)||void 0===b?void 0:b.targetLayerUrls)&&void 0!==j?j:[],X=e=>{var t,i,o,n,l;return null!==(l=null!==(n=null!==(i=null===(t=null==e?void 0:e.getData)||void 0===t?void 0:t.call(e))&&void 0!==i?i:null===(o=null==e?void 0:e.feature)||void 0===o?void 0:o.attributes)&&void 0!==n?n:null==e?void 0:e.attributes)&&void 0!==l?l:{}},Z=()=>M(!1),ee=()=>o(this,void 0,void 0,function*(){var e;if(!L)return null;const t=null===(e=L.view)||void 0===e?void 0:e.map;if(!t)return null;if(W.current)return W.current;const{default:i}=yield Promise.resolve().then(g.bind(g,620)),o=new i({title:"Vehicle Buffer (Widget)"});return t.add(o),W.current=o,o}),te=(e,t)=>o(this,void 0,void 0,function*(){var i;const[{default:o}]=yield Promise.all([Promise.resolve().then(g.bind(g,470))]),n=yield ee();n&&(n.removeAll(),n.addMany([new o({geometry:t,symbol:{type:"simple-fill",color:[0,122,255,.15],outline:{color:[0,122,255,.9],width:2}}}),new o({geometry:e,symbol:{type:"simple-marker",style:"circle",size:10,color:[0,122,255,1],outline:{color:[255,255,255,1],width:1}}})]),(null==t?void 0:t.extent)&&(null===(i=null==L?void 0:L.view)||void 0===i||i.goTo(t.extent.expand(1.25)).catch(()=>{})))}),ie=e=>o(this,void 0,void 0,function*(){var t,i;const o=X(e),n=null===(t=null==e?void 0:e.feature)||void 0===t?void 0:t.geometry,[{default:l},r]=yield Promise.all([Promise.resolve().then(g.bind(g,422)),Promise.resolve().then(g.bind(g,958))]),d=null!==(i=r.default)&&void 0!==i?i:r;let u=null;if(n&&"point"===n.type?u=n:"number"==typeof(null==o?void 0:o.Longitude)&&"number"==typeof(null==o?void 0:o.Latitude)&&(u=new l({longitude:o.Longitude,latitude:o.Latitude,spatialReference:{wkid:4326}})),!u)return null;const s=d.geodesicBuffer?d.geodesicBuffer(u,J,V):d.buffer(u,J,V);return yield te(u,s),s}),oe=(e,t)=>o(this,void 0,void 0,function*(){var i,o,l;if(!e||!t)return{geom:e,usedProjection:!1};const[{default:r},d,u,s]=yield Promise.all([Promise.resolve().then(g.bind(g,205)),Promise.resolve().then(g.bind(g,333)),Promise.resolve().then(g.bind(g,569)),Promise.resolve().then(g.bind(g,507))]),a=null!==(i=d.default)&&void 0!==i?i:d,c=null!==(o=u.default)&&void 0!==o?o:u,v=null!==(l=s.default)&&void 0!==l?l:s,f=t instanceof r?t:new r(t),y=null==e?void 0:e.spatialReference,p=null==y?void 0:y.wkid,m=null==f?void 0:f.wkid;if(p&&m&&p===m)return{geom:e,usedProjection:!1};try{if((null==a?void 0:a.load)&&(yield a.load()),null==a?void 0:a.project){const t=a.project(e,f);if(t)return{geom:t,usedProjection:!0}}}catch(e){}try{const t=new v({geometries:[e],outSpatialReference:f}),i=yield c.project(n,t);if(null==i?void 0:i.length)return{geom:i[0],usedProjection:!0}}catch(e){}return{geom:e,usedProjection:!1}}),ne=e=>o(this,void 0,void 0,function*(){var t,i,o;try{R(!0),k("");const o=yield e.query({where:"1=1",outFields:["*"],pageSize:200,returnGeometry:!0}),n=null!==(i=null!==(t=null==o?void 0:o.records)&&void 0!==t?t:o)&&void 0!==i?i:[];S(n)}catch(e){S([]),k(null!==(o=null==e?void 0:e.message)&&void 0!==o?o:"Failed to query the selected vehicle layer.")}finally{R(!1)}}),le=e=>o(this,void 0,void 0,function*(){var i,o,n,r,s,a,c;D(!0),k(""),U([]),T(null);const v=[];try{const c=(()=>{var e;const i=(null!=K?K:[]).map(e=>d(e)).filter(e=>!!e);if(i.length>0)return i.map((e,t)=>({title:$[t]||e,url:e,source:"config-url"}));const o=null!==(e=u.useDataSources)&&void 0!==e?e:[],n=o.length>1?o.slice(1):[],l=t.DataSourceManager.getInstance();return n.map(e=>{var t,i,o,n;const r=null==e?void 0:e.dataSourceId,u=(null==e?void 0:e.label)||r||"Target";let s="";try{const e=l.getDataSource(r),u=null===(t=null==e?void 0:e.getDataSourceJson)||void 0===t?void 0:t.call(e);s=d((null==u?void 0:u.url)||(null===(i=null==e?void 0:e.layer)||void 0===i?void 0:i.url)||(null===(n=null===(o=null==e?void 0:e.getLayer)||void 0===o?void 0:o.call(e))||void 0===n?void 0:n.url))}catch(e){s=""}return{title:u,url:s,source:"useDataSources",dsId:r}}).filter(e=>!!e.url)})();if(0===c.length)return void U([{key:"no-targets",title:"No target layers configured",count:0,items:[],debug:{bufferWkid:null===(i=null==e?void 0:e.spatialReference)||void 0===i?void 0:i.wkid,error:"No target URLs found. Pick at least one target layer in widget settings. If you already did, restart dev server and hard refresh."}}]);const{default:f}=yield Promise.resolve().then(g.bind(g,633));for(const t of c){const i=t.url,d=t.title,u=new f({url:i});yield u.load();const c=(null==u?void 0:u.spatialReference)||(null===(o=null==L?void 0:L.view)||void 0===o?void 0:o.spatialReference),{geom:g,usedProjection:y}=yield oe(e,c),p=u.createQuery();p.where="1=1",p.geometry=g,p.spatialRelationship="intersects",p.outFields=["*"],p.returnGeometry=!0;let m=[];try{const e=yield u.queryFeatures(p);m=null!==(n=null==e?void 0:e.features)&&void 0!==n?n:[]}catch(o){v.push({key:i,title:d,count:0,items:[],debug:{bufferWkid:null===(r=null==e?void 0:e.spatialReference)||void 0===r?void 0:r.wkid,layerWkid:null==c?void 0:c.wkid,targetUrl:i,source:t.source,dsId:t.dsId,usedProjection:y,error:null!==(s=null==o?void 0:o.message)&&void 0!==s?s:String(o)}});continue}const h=m.map(e=>{var t;return{title:l(null==e?void 0:e.attributes),attrs:null!==(t=null==e?void 0:e.attributes)&&void 0!==t?t:{},geometry:null==e?void 0:e.geometry}});v.push({key:i,title:(null==u?void 0:u.title)||d,count:h.length,items:h,debug:{bufferWkid:null===(a=null==e?void 0:e.spatialReference)||void 0===a?void 0:a.wkid,layerWkid:null==c?void 0:c.wkid,targetUrl:i,source:t.source,dsId:t.dsId,usedProjection:y}})}v.sort((e,t)=>t.count-e.count),U(v)}catch(e){k(null!==(c=null==e?void 0:e.message)&&void 0!==c?c:"Target query failed.")}finally{D(!1)}}),re=e=>o(this,void 0,void 0,function*(){_(e),M(!0),N({}),U([]),T(null);const t=yield ie(e);t&&(yield le(t))});return(0,e.jsxs)("div",{style:{padding:12},children:[!!H&&(0,e.jsx)(i.JimuMapViewComponent,{useMapWidgetId:H,onActiveViewChange:e=>B(e)}),(0,e.jsx)("div",{style:{fontWeight:600,marginBottom:6},children:Y}),(0,e.jsxs)("div",{style:{fontSize:12,marginBottom:10},children:["Buffer: ",J," ",V]}),!H&&(0,e.jsx)("div",{style:{padding:10,border:"1px solid #999",borderRadius:4,fontSize:12,marginBottom:10},children:"Select a Map widget in Content settings."}),!q&&(0,e.jsx)("div",{style:{padding:10,border:"1px solid #999",borderRadius:4,fontSize:12},children:"Select a vehicle layer in Content settings."}),q&&(0,e.jsx)(t.DataSourceComponent,{useDataSource:q,widgetId:u.id,onDataSourceCreated:e=>o(this,void 0,void 0,function*(){yield ne(e)}),onDataSourceInfoChange:(e,t)=>o(this,void 0,void 0,function*(){t&&"loaded"===(null==e?void 0:e.status)&&(yield ne(t))})}),P&&(0,e.jsx)("div",{style:{fontSize:12,marginTop:8},children:"Loading features..."}),w&&(0,e.jsx)("div",{style:{marginTop:10,padding:10,border:"1px solid #c00",borderRadius:4,fontSize:12},children:w}),(0,e.jsx)("div",{style:{maxHeight:260,overflowY:"auto",border:"1px solid #ddd",borderRadius:6,padding:"6px 8px",marginTop:10},children:(0,e.jsx)("ul",{style:{margin:0,paddingLeft:18},children:x.map((t,i)=>(0,e.jsx)("li",{style:{marginBottom:6},children:(0,e.jsx)("button",{type:"button",onClick:()=>{re(t)},style:{all:"unset",cursor:"pointer",textDecoration:"underline"},children:r(X(t),Q)})},i))})}),C&&I&&(0,e.jsx)("div",{role:"dialog","aria-modal":"true",style:{position:"fixed",inset:0,background:"rgba(0,0,0,0.45)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:9999},onClick:Z,children:(0,e.jsxs)("div",{style:{width:"min(980px, 94vw)",maxHeight:"84vh",overflow:"auto",background:"#fff",borderRadius:8,padding:16,display:"grid",gridTemplateColumns:"1fr 1fr",gap:12},onClick:e=>e.stopPropagation(),children:[(0,e.jsxs)("div",{children:[(0,e.jsxs)("div",{style:{display:"flex",justifyContent:"space-between",gap:12},children:[(0,e.jsx)("div",{style:{fontWeight:700},children:r(X(I),Q)}),(0,e.jsx)("button",{type:"button",onClick:Z,style:{cursor:"pointer"},children:"Close"})]}),(0,e.jsxs)("div",{style:{marginTop:10,fontSize:12},children:[(0,e.jsx)("div",{style:{marginBottom:8,fontWeight:600},children:"Results inside buffer"}),(0,e.jsx)("button",{type:"button",onClick:()=>G(e=>!e),style:{fontSize:12,cursor:"pointer",marginBottom:10},children:F?"Hide debug":"Show debug"}),F&&(0,e.jsx)("pre",{style:{background:"#f6f6f6",padding:10,borderRadius:6,fontSize:11,whiteSpace:"pre-wrap"},children:JSON.stringify(z.map(e=>{var t,i,o,n,l,r,d;return{layer:e.title,key:e.key,count:e.count,bufferWkid:null===(t=e.debug)||void 0===t?void 0:t.bufferWkid,layerWkid:null===(i=e.debug)||void 0===i?void 0:i.layerWkid,targetUrl:null===(o=e.debug)||void 0===o?void 0:o.targetUrl,source:null===(n=e.debug)||void 0===n?void 0:n.source,dsId:null===(l=e.debug)||void 0===l?void 0:l.dsId,usedProjection:null===(r=e.debug)||void 0===r?void 0:r.usedProjection,error:null===(d=e.debug)||void 0===d?void 0:d.error}}),null,2)}),O&&(0,e.jsx)("div",{children:"Querying target layers..."}),!O&&z.map(t=>(0,e.jsxs)("div",{style:{border:"1px solid #ddd",borderRadius:6,marginBottom:10},children:[(0,e.jsxs)("button",{type:"button",onClick:()=>{return e=t.key,N(t=>Object.assign(Object.assign({},t),{[e]:!t[e]}));var e},style:{width:"100%",textAlign:"left",padding:10,cursor:"pointer",background:"#f6f6f6",border:"none"},children:[(0,e.jsx)("strong",{children:t.title})," (",t.count,")"]}),A[t.key]&&(0,e.jsxs)("ul",{style:{paddingLeft:18,margin:10},children:[t.items.slice(0,250).map((t,i)=>(0,e.jsx)("li",{style:{marginBottom:6},children:(0,e.jsx)("button",{type:"button",onClick:()=>T(t),style:{all:"unset",cursor:"pointer",textDecoration:"underline"},children:t.title})},i)),t.items.length>250&&(0,e.jsx)("li",{children:"Showing first 250 results..."})]})]},t.key))]})]}),(0,e.jsxs)("div",{children:[(0,e.jsx)("div",{style:{fontWeight:600,marginBottom:8},children:"Details"}),!E&&(0,e.jsx)("div",{style:{fontSize:12,padding:10,border:"1px solid #ddd",borderRadius:6},children:"Click an item in the results list to view its attributes."}),E&&(0,e.jsx)("pre",{style:{whiteSpace:"pre-wrap",wordBreak:"break-word",background:"#f6f6f6",padding:10,borderRadius:6,fontSize:12},children:JSON.stringify(E.attrs,null,2)})]})]})})]})}function s(e){g.p=e}})(),y})())}}});